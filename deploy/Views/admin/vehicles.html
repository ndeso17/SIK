{% extends 'base.html' %}

{% block title %}Daftar Kendaraan - Sistem Identitas Kendaraan{% endblock %}
{% block page_title %}Daftar Kendaraan{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h5 class="mb-0">Daftar Kendaraan</h5>
        <p class="text-muted mb-0">Kelola dan verifikasi identitas kendaraan</p>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" name="search" placeholder="Cari plat..." 
                       value="{{ search }}">
            </div>
            <div class="col-md-2">
                <select class="form-select" name="status">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Semua Status</option>
                    <option value="verified" {% if status_filter == 'verified' %}selected{% endif %}>Terverifikasi</option>
                    <option value="unverified" {% if status_filter == 'unverified' %}selected{% endif %}>Belum Verifikasi</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="method">
                    <option value="all" {% if method_filter == 'all' %}selected{% endif %}>Semua Metode</option>
                    <option value="plate" {% if method_filter == 'plate' %}selected{% endif %}>OCR Plat</option>
                    <option value="face" {% if method_filter == 'face' %}selected{% endif %}>Pengenalan Wajah</option>
                    <option value="visual" {% if method_filter == 'visual' %}selected{% endif %}>Fitur Visual</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="type">
                    <option value="all" {% if type_filter == 'all' %}selected{% endif %}>Semua Jenis</option>
                    <option value="car" {% if type_filter == 'car' %}selected{% endif %}>Mobil</option>
                    <option value="motorcycle" {% if type_filter == 'motorcycle' %}selected{% endif %}>Motor</option>
                    <option value="bus" {% if type_filter == 'bus' %}selected{% endif %}>Bus</option>
                    <option value="truck" {% if type_filter == 'truck' %}selected{% endif %}>Truk</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> Filter
                </button>
                <a href="{{ url_for('admin.vehicles_list') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Reset
                </a>
            </div>
        </form>
    </div>
</div>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Daftar Kendaraan</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <div class="btn-group me-2">
      <button type="button" class="btn btn-sm btn-outline-danger me-2 d-none" id="btnBulkDelete" onclick="deleteSelected()">
        <i class="fas fa-trash"></i> Hapus Terpilih
      </button>
      <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportVehiclesCSV()">
        <i class="fas fa-download"></i> Ekspor CSV
      </button>
    </div>
  </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="row align-items-center">
            <div class="col">
                <form class="d-flex" action="{{ url_for('admin.vehicles_list') }}" method="get">
                    <input class="form-control form-control-sm me-2" type="search" placeholder="Cari Plat..." aria-label="Search">
                    <button class="btn btn-sm btn-outline-primary" type="submit">Cari</button>
                </form>
            </div>
            <div class="col-auto">
                <span class="text-muted small">Menampilkan {{ vehicles|length }} hasil</span>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="40"><input type="checkbox" class="form-check-input" id="selectAll"></th>
                        <th>ID</th>
                        <th>Plat Nomor</th>
                        <th>Jenis</th>
                        <th>Warna</th>
                        <th>Pengemudi</th>
                        <th>Terakhir Dilihat</th>
                        <th>Keyakinan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vehicles %}
                    <tr>
                        <td><input type="checkbox" class="form-check-input vehicle-select" value="{{ v.id }}"></td>
                        <td>{{ v.id }}</td>
                        <td class="fw-bold">
                            {{ v.plate_text or 'Tidak Diketahui' }}
                            {% if v.is_manually_annotated %}
                                <i class="fas fa-check-circle text-info ms-1" title="Terverifikasi Manual"></i>
                            {% endif %}
                        </td>
                        <td>
                            {% set type_map = {'car': 'Mobil', 'motorcycle': 'Motor', 'bus': 'Bus', 'truck': 'Truk'} %}
                            <span class="badge bg-secondary">{{ type_map.get(v.vehicle_type, v.vehicle_type) or '-' }}</span>
                        </td>
                        <td>
                            {% set color_map = {
                                'merah': '#ef4444', 'red': '#ef4444',
                                'hitam': '#000000', 'black': '#000000',
                                'putih': '#ffffff', 'white': '#ffffff',
                                'biru': '#2563eb', 'blue': '#2563eb',
                                'kuning': '#facc15', 'yellow': '#facc15',
                                'abu-abu': '#6b7280', 'grey': '#6b7280', 'silver': '#d1d5db',
                                'hijau': '#16a34a', 'green': '#16a34a',
                                'coklat': '#92400e', 'brown': '#92400e',
                                'ungu': '#7c3aed', 'purple': '#7c3aed',
                                'orange': '#f97316', 'oranye': '#f97316'
                            } %}
                            
                            {% set bg_color = color_map.get((v.vehicle_color or '')|lower, '#d1d5db') %}
                            {% set text_color = 'black' if bg_color in ['#ffffff', '#facc15', '#d1d5db', '#ffffff'] else 'white' %}
                            {% set border_style = '1px solid #ccc' if bg_color == '#ffffff' else 'none' %}
                            
                            <span class="badge" style="background-color: {{ bg_color }}; color: {{ text_color }}; border: {{ border_style }};">
                                {{ v.vehicle_color or '-' }}
                            </span>
                        </td>
                        <td>
                            {% if v.driver_name %}
                                {{ v.driver_name }}
                                <i class="fas fa-check-circle text-success small ms-1" title="Terverifikasi"></i>
                            {% elif v.has_driver %}
                                <span class="badge bg-info">Terdeteksi</span>
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td>{{ v.last_seen.strftime('%d/%m %H:%M') }}</td>
                        <td>
                            {% if v.is_verified %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> Verified
                                </span>
                            {% elif v.avg_confidence %}
                                <div class="d-flex align-items-center">
                                    <div class="progress" style="height: 5px; width: 50px;">
                                        <div class="progress-bar bg-primary" role="progressbar" 
                                             style="width: {{ (v.avg_confidence * 100)|round|int }}%"></div>
                                    </div>
                                    <small class="text-muted ms-2">{{ (v.avg_confidence * 100)|round|int }}%</small>
                                </div>
                            {% else %}
                                <span class="text-muted small">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('admin.vehicle_detail', id=v.id) }}" class="btn btn-sm btn-primary">Detail</a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteIdentity({{ v.id }})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if pagination.pages > 1 %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.vehicles_list', page=pagination.prev_num, search=search, status=status_filter, method=method_filter, type=type_filter) }}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        {% endif %}
        
        {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
                <li class="page-item {{ 'active' if p == pagination.page else '' }}">
                    <a class="page-link" href="{{ url_for('admin.vehicles_list', page=p, search=search, status=status_filter, method=method_filter, type=type_filter) }}">{{ p }}</a>
                </li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}
        
{% if pagination.has_next %}\n            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin.vehicles_list', page=pagination.next_num, search=search, status=status_filter, method=method_filter, type=type_filter) }}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
<p class="text-center text-muted">
    Menampilkan halaman {{ pagination.page }} dari {{ pagination.pages }} (Total {{ pagination.total }})
</p>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function exportVehiclesCSV() {
    window.location.href = '/api/vehicles/export';
}

// Select All Handler
document.getElementById('selectAll').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.vehicle-select');
    checkboxes.forEach(cb => cb.checked = this.checked);
    updateBulkButton();
});

// Individual Select Handler
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('vehicle-select')) {
        updateBulkButton();
    }
});

function updateBulkButton() {
    const checked = document.querySelectorAll('.vehicle-select:checked');
    const btn = document.getElementById('btnBulkDelete');
    if (checked.length > 0) {
        btn.classList.remove('d-none');
        btn.innerHTML = `<i class="fas fa-trash"></i> Hapus Terpilih (${checked.length})`;
    } else {
        btn.classList.add('d-none');
    }
}

function deleteIdentity(id) {
    Swal.fire({
        title: 'Hapus Identitas?',
        text: 'Aksi ini akan menghapus data identitas dan semua riwayat observasinya secara permanen.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/identities/${id}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire(
                        'Terhapus!',
                        'Identitas berhasil dihapus.',
                        'success'
                    ).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire(
                        'Gagal!',
                        data.error || 'Terjadi kesalahan.',
                        'error'
                    );
                }
            })
            .catch(err => {
                Swal.fire('Error', 'Gagal menghubungi server.', 'error');
            });
        }
    });
}

function deleteSelected() {
    const checked = document.querySelectorAll('.vehicle-select:checked');
    const ids = Array.from(checked).map(cb => cb.value);
    
    Swal.fire({
        title: `Hapus ${ids.length} Identitas?`,
        text: 'Aksi ini tidak dapat dibatalkan. Semua data terkait akan hilang.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus Semua',
        cancelButtonText: 'Batal'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/identities/bulk_delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ids: ids })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    Swal.fire(
                        'Terhapus!',
                        data.message,
                        'success'
                    ).then(() => {
                        window.location.reload();
                    });
                } else {
                    Swal.fire(
                        'Gagal!',
                        data.error || 'Terjadi kesalahan.',
                        'error'
                    );
                }
            })
            .catch(err => {
                Swal.fire('Error', 'Gagal menghubungi server.', 'error');
            });
        }
    });
}
</script>
{% endblock %}
